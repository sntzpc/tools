<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Calendar Bulk Upload - Multi Hari</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Ctext y='54' x='6' font-size='56'%3E%F0%9F%93%85%3C/text%3E%3C/svg%3E" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
     <style>
        * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
    padding: 20px;
    color: #333;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    background: white;
    border-radius: 20px;
    padding: 40px;
    box-shadow: 0 15px 35px rgba(50, 50, 93, 0.1), 0 5px 15px rgba(0, 0, 0, 0.07);
}

h1 {
    color: #2c3e50;
    margin-bottom: 30px;
    text-align: center;
    font-size: 2.8em;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
}

h1 i {
    color: #4285f4;
}

h3 {
    color: #34495e;
    margin-bottom: 20px;
    font-size: 1.4em;
    display: flex;
    align-items: center;
    gap: 10px;
}

.upload-section, .manual-input, .events-list, .instructions {
    margin-bottom: 30px;
    padding: 25px;
    border-radius: 15px;
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.upload-section:hover, .manual-input:hover {
    border-color: #4285f4;
    box-shadow: 0 5px 15px rgba(66, 133, 244, 0.1);
}

input[type="file"] {
    display: block;
    margin: 15px 0;
    padding: 15px;
    border: 2px dashed #4285f4;
    border-radius: 10px;
    width: 100%;
    background: white;
    cursor: pointer;
    font-size: 16px;
}

input[type="file"]:hover {
    background: #f8fbff;
}

.template-download {
    margin-top: 15px;
    text-align: center;
}

.btn-template {
    background: #6c757d;
    padding: 12px 25px;
    border-radius: 8px;
    font-size: 16px;
    display: inline-flex;
    align-items: center;
    gap: 10px;
}

.form-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.form-row {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-row.full-width {
    grid-column: 1 / -1;
}

.form-row label {
    font-weight: 600;
    color: #495057;
    font-size: 14px;
}

.form-row label::after {
    content: '*';
    color: #dc3545;
    margin-left: 4px;
}

.form-row label:not([for*="Date"]):not([for="eventTitle"]):not([for="allDayEvent"])::after {
    content: '';
}

input[type="text"], input[type="date"], input[type="time"], textarea, select {
    padding: 12px 15px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    font-size: 15px;
    transition: border-color 0.3s;
    width: 100%;
}

input[type="text"]:focus, input[type="date"]:focus, input[type="time"]:focus, textarea:focus {
    border-color: #4285f4;
    outline: none;
    box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
}

textarea {
    min-height: 80px;
    resize: vertical;
    font-family: inherit;
}

.checkbox-group {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    background: #e8f4fe;
    border-radius: 8px;
}

.checkbox-group input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.checkbox-group label {
    cursor: pointer;
    font-weight: normal;
}

.btn-add {
    background: #4285f4;
    color: white;
    padding: 15px 30px;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin: 0 auto;
    width: 200px;
    transition: all 0.3s;
}

.btn-add:hover {
    background: #3367d6;
    transform: translateY(-3px);
    box-shadow: 0 7px 14px rgba(66, 133, 244, 0.3);
}

.events-list {
    overflow: hidden;
}

.table-container {
    overflow-x: auto;
    border-radius: 10px;
    border: 1px solid #dee2e6;
    margin: 15px 0;
}

table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
}

thead {
    background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
    color: white;
}

thead th {
    padding: 18px 15px;
    text-align: left;
    font-weight: 600;
    font-size: 15px;
}

thead th:first-child {
    border-radius: 10px 0 0 0;
}

thead th:last-child {
    border-radius: 0 10px 0 0;
}

tbody tr {
    border-bottom: 1px solid #e9ecef;
    transition: background-color 0.2s;
}

tbody tr:hover {
    background-color: #f8fbff;
}

tbody td {
    padding: 15px;
    vertical-align: middle;
}

tbody tr:nth-child(even) {
    background-color: #f8f9fa;
}

tbody tr:nth-child(even):hover {
    background-color: #f0f7ff;
}

.duration {
    background: #e8f5e9;
    color: #2e7d32;
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    display: inline-block;
}

.multi-day {
    background: #fff3e0;
    color: #ef6c00;
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    display: inline-block;
}

.delete-btn {
    background: #dc3545;
    color: white;
    padding: 8px 15px;
    border-radius: 6px;
    font-size: 14px;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
}

.delete-btn:hover {
    background: #c82333;
    transform: scale(1.05);
}

.summary {
    background: #e3f2fd;
    padding: 15px;
    border-radius: 10px;
    margin-top: 20px;
    display: flex;
    justify-content: center;
    gap: 30px;
    font-weight: 600;
    color: #1976d2;
}

.summary i {
    margin-right: 8px;
}

.actions {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: center;
    margin: 40px 0;
}

.actions button {
    padding: 15px 30px;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    min-width: 220px;
    cursor: pointer;
    transition: all 0.3s;
    border: none;
}

.btn-primary {
    background: linear-gradient(135deg, #34a853 0%, #0d904f 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-3px);
    box-shadow: 0 7px 14px rgba(52, 168, 83, 0.3);
}

.btn-secondary {
    background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
    color: white;
}

.btn-secondary:hover {
    transform: translateY(-3px);
    box-shadow: 0 7px 14px rgba(108, 117, 125, 0.3);
}

.btn-success {
    background: linear-gradient(135deg, #4285f4 0%, #3367d6 100%);
    color: white;
}

.btn-success:hover {
    transform: translateY(-3px);
    box-shadow: 0 7px 14px rgba(66, 133, 244, 0.3);
}

.btn-ics {
    background: linear-gradient(135deg, #ea4335 0%, #d23c2e 100%);
    color: white;
}

.btn-ics:hover {
    transform: translateY(-3px);
    box-shadow: 0 7px 14px rgba(234, 67, 53, 0.3);
}

.instructions {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 2px solid #dee2e6;
}

.instruction-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 30px;
    margin: 20px 0;
}

.instruction-item {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.08);
}

.instruction-item pre {
    background: #2d3748;
    color: #e2e8f0;
    padding: 15px;
    border-radius: 8px;
    overflow-x: auto;
    font-size: 14px;
    margin: 10px 0;
}

.instruction-item p {
    margin: 10px 0;
    line-height: 1.6;
}

.instruction-item ol, .instruction-item ul {
    margin-left: 20px;
    line-height: 1.8;
}

.tips {
    background: #fff8e1;
    padding: 20px;
    border-radius: 10px;
    margin-top: 20px;
    border-left: 5px solid #ffc107;
}

.tips ul {
    margin-left: 20px;
    line-height: 1.8;
}

.tips li {
    margin: 8px 0;
}

.footer {
    text-align: center;
    margin-top: 40px;
    padding-top: 20px;
    border-top: 1px solid #e9ecef;
    color: #6c757d;
    font-size: 14px;
}

.footer i.fa-heart {
    color: #dc3545;
    animation: heartbeat 1.5s infinite;
}

@keyframes heartbeat {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

/* Responsive Design */
@media (max-width: 768px) {
    .container {
        padding: 20px;
    }
    
    h1 {
        font-size: 2em;
        flex-direction: column;
        text-align: center;
    }
    
    .form-group {
        grid-template-columns: 1fr;
    }
    
    .actions {
        flex-direction: column;
        align-items: center;
    }
    
    .actions button {
        width: 100%;
    }
    
    .instruction-grid {
        grid-template-columns: 1fr;
    }
}

/* Loading spinner */
.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Edit button */
.edit-btn{
  background: #ffc107;
  color: #212529;
  padding: 8px 15px;
  border-radius: 6px;
  font-size: 14px;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  border: none;
  cursor: pointer;
  transition: all 0.2s;
  margin-right: 8px;
}
.edit-btn:hover{
  background: #e0a800;
  transform: scale(1.05);
}

/* Button state when editing */
.btn-add.btn-editing{
  background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
  color: #212529;
}

     </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-calendar-alt"></i> Google Calendar Bulk Upload - Multi Hari</h1>
        
        <div class="upload-section">
            <h3><i class="fas fa-upload"></i> 1. Upload File Excel/CSV</h3>
            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls,.ics">
            <div class="template-download">
                <button onclick="downloadTemplate()" class="btn-success">
                    <i class="fas fa-download"></i> Download Template CSV
                </button>
                <button onclick="generateXLSX()" class="btn-primary">
                    <i class="fas fa-file-excel"></i> Download File XLSX
                </button>
                <button onclick="pickICSFile()" class="btn-ics">
                    <i class="fas fa-file-import"></i> Import File ICS
                </button>
            </div>
        </div>

        <div class="manual-input">
            <h3><i class="fas fa-plus-circle"></i> 2. Input Manual Acara</h3>
            <div class="form-group">
                <div class="form-row">
                    <label>Judul Acara*</label>
                    <input type="text" id="eventTitle" placeholder="Misal: Training, Rapat, Liburan">
                </div>
                
                <div class="form-row">
                    <label>Tanggal Mulai*</label>
                    <input type="date" id="startDate">
                </div>
                
                <div class="form-row">
                    <label>Tanggal Selesai*</label>
                    <input type="date" id="endDate">
                </div>
                
                <div class="form-row">
                    <label>Waktu Mulai</label>
                    <input type="time" id="startTime">
                </div>
                
                <div class="form-row">
                    <label>Waktu Selesai</label>
                    <input type="time" id="endTime">
                </div>
                
                <div class="form-row">
                    <label>Lokasi</label>
                    <input type="text" id="eventLocation" placeholder="Tempat acara">
                </div>
                
                <div class="form-row full-width">
                    <label>Deskripsi</label>
                    <textarea id="eventDescription" placeholder="Detail acara"></textarea>
                </div>
                
                <div class="form-row full-width">
                    <div class="checkbox-group">
                        <input type="checkbox" id="allDayEvent">
                        <label for="allDayEvent">Acara seharian (tanpa waktu spesifik)</label>
                    </div>
                </div>
            </div>
            
            <button onclick="addManualEvent()" class="btn-add">
                <i class="fas fa-plus"></i> Tambah ke List
            </button>
        </div>

        <div class="events-list">
            <h3><i class="fas fa-list"></i> Daftar Acara (${events.length} acara)</h3>
            <div class="table-container">
                <table id="eventsTable">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Judul Acara</th>
                            <th>Tanggal Mulai</th>
                            <th>Tanggal Selesai</th>
                            <th>Waktu</th>
                            <th>Durasi</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="eventsBody">
                        <!-- Data akan diisi oleh JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div class="summary">
                <p><i class="fas fa-info-circle"></i> Total: <span id="totalEvents">0</span> acara | 
                Acara multi-hari: <span id="multiDayCount">0</span></p>
            </div>
        </div>

        <div class="actions">
            <button onclick="generateCSV()" class="btn-primary">
                <i class="fas fa-file-csv"></i> Download File CSV
            </button>
            <button onclick="clearAll()" class="btn-secondary">
                <i class="fas fa-trash"></i> Hapus Semua
            </button>
            <button onclick="openGoogleCalendar()" class="btn-success">
                <i class="fas fa-external-link-alt"></i> Buka Google Calendar
            </button>
            <button onclick="importICS()" class="btn-ics">
                <i class="fas fa-file-export"></i> Generate File ICS
            </button>
        </div>

        <div class="instructions">
            <h3><i class="fas fa-graduation-cap"></i> Panduan Format CSV untuk Multi-Hari:</h3>
            <div class="instruction-grid">
                <div class="instruction-item">
                    <h4><i class="fas fa-file-csv"></i> Format Kolom:</h4>
                    <pre>Subject,Start Date,Start Time,End Date,End Time,Description,Location</pre>
                    <p><strong>Contoh Acara 1 Hari:</strong><br>
                    Meeting,2024-01-20,14:00,2024-01-20,15:00,Rapat tim,Kantor</p>
                    <p><strong>Contoh Acara Multi-Hari:</strong><br>
                    Training,2024-01-22,09:00,2024-01-24,17:00,Training karyawan,Room A</p>
                    <p><strong>Contoh Acara Seharian:</strong><br>
                    Libur Nasional,2024-01-01,,2024-01-01,,Hari Tahun Baru,</p>
                </div>
                
                <div class="instruction-item">
                    <h4><i class="fas fa-calendar-check"></i> Cara Upload:</h4>
                    <ol>
                        <li>Download file CSV dari aplikasi ini</li>
                        <li>Buka <a href="https://calendar.google.com" target="_blank">calendar.google.com</a></li>
                        <li>Di sidebar kanan, klik ⚙️ <strong>Settings</strong></li>
                        <li>Pilih <strong>Import & export</strong> → <strong>Import</strong></li>
                        <li>Pilih file CSV yang didownload</li>
                        <li>Pilih kalender tujuan → Klik <strong>Import</strong></li>
                        <li>Tunggu proses selesai (bisa beberapa detik)</li>
                    </ol>
                </div>
            </div>
            
            <div class="tips">
                <h4><i class="fas fa-lightbulb"></i> Tips:</h4>
                <ul>
                    <li>Untuk acara multi-hari, pastikan <strong>End Date</strong> lebih besar dari <strong>Start Date</strong></li>
                    <li>Kolom waktu bisa dikosongkan untuk acara seharian (All Day Event)</li>
                    <li>Google Calendar akan otomatis mengatur timezone sesuai pengaturan kalender Anda</li>
                    <li>Maksimal 10,000 acara per file CSV</li>
                </ul>
            </div>
        </div>
        
        <div class="footer">
            <p>Dibuat dengan <i class="fas fa-heart"></i> untuk memudahkan upload jadwal ke Google Calendar</p>
        </div>
    </div>

    <script>
        let events = [];

// =====================
// LOCAL STORAGE (PERSISTENCE)
// =====================
const STORAGE_KEY_EVENTS = 'gcal_bulk_events_v1';

function saveEventsLocal(){
  try{
    localStorage.setItem(STORAGE_KEY_EVENTS, JSON.stringify(events || []));
  }catch(e){
    console.warn('Gagal simpan localStorage:', e);
  }
}

function loadEventsLocal(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY_EVENTS);
    if (!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  }catch(e){
    console.warn('Gagal load localStorage:', e);
    return [];
  }
}

function clearEventsLocal(){
  try{
    localStorage.removeItem(STORAGE_KEY_EVENTS);
  }catch(e){
    console.warn('Gagal hapus localStorage:', e);
  }
}


// =====================
// EDIT MODE STATE
// =====================
let editIndex = -1; // -1 = mode tambah, >=0 = sedang edit index event

function getFormEvent(){
  return {
    subject: document.getElementById('eventTitle').value,
    startDate: document.getElementById('startDate').value,
    endDate: document.getElementById('endDate').value,
    startTime: document.getElementById('startTime').value,
    endTime: document.getElementById('endTime').value,
    location: document.getElementById('eventLocation').value,
    description: document.getElementById('eventDescription').value,
    allDay: document.getElementById('allDayEvent').checked
  };
}

function setFormEvent(ev){
  document.getElementById('eventTitle').value = ev.subject || '';
  document.getElementById('startDate').value = ev.startDate || '';
  document.getElementById('endDate').value = ev.endDate || (ev.startDate || '');
  document.getElementById('startTime').value = ev.startTime || '';
  document.getElementById('endTime').value = ev.endTime || '';
  document.getElementById('eventLocation').value = ev.location || '';
  document.getElementById('eventDescription').value = ev.description || '';
  document.getElementById('allDayEvent').checked = !!ev.allDay;
}

function resetFormToDefault(){
  document.getElementById('eventTitle').value = '';
  document.getElementById('eventLocation').value = '';
  document.getElementById('eventDescription').value = '';
  document.getElementById('allDayEvent').checked = false;

  const today = new Date();
  document.getElementById('startDate').value = today.toISOString().split('T')[0];
  document.getElementById('endDate').value = today.toISOString().split('T')[0];
  document.getElementById('startTime').value = '09:00';
  document.getElementById('endTime').value = '17:00';

  editIndex = -1;
  updateAddButtonUI();
}

function updateAddButtonUI(){
  const btn = document.querySelector('.manual-input .btn-add');
  if (!btn) return;

  if (editIndex >= 0){
    btn.innerHTML = `<i class="fas fa-save"></i> Simpan Perubahan`;
    btn.classList.add('btn-editing');
  } else {
    btn.innerHTML = `<i class="fas fa-plus"></i> Tambah ke List`;
    btn.classList.remove('btn-editing');
  }
}

// =====================
// HELPERS: NOTIF STYLE ONCE
// =====================
let __notifStyleInjected = false;
function ensureNotificationStyle(){
  if (__notifStyleInjected) return;
  __notifStyleInjected = true;

  const style = document.createElement('style');
  style.textContent = `
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
      z-index: 1000;
      animation: slideIn 0.3s ease;
      max-width: 420px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      font-weight: 500;
    }
    .notification-success { background: #d4edda; color: #155724; border-left: 5px solid #28a745; }
    .notification-error   { background: #f8d7da; color: #721c24; border-left: 5px solid #dc3545; }
    .notification-info    { background: #d1ecf1; color: #0c5460; border-left: 5px solid #17a2b8; }
    .notification button {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      padding: 0;
      font-size: 18px;
    }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  `;
  document.head.appendChild(style);
}

// =====================
// DATE/TIME HELPERS
// =====================
function pad2(n){ return String(n).padStart(2,'0'); }

// ICS datetime like: 20250105T090000 or 20250105 (all day)
function parseICalDate(val){
  const v = String(val || '').trim();
  if (!v) return null;

  // All-day: YYYYMMDD
  if (/^\d{8}$/.test(v)){
    const y = v.slice(0,4), m = v.slice(4,6), d = v.slice(6,8);
    return { date: `${y}-${m}-${d}`, time: '' , allDay: true };
  }

  // Date-time: YYYYMMDDTHHMMSS (ignore trailing Z)
  const vv = v.replace(/Z$/,'');
  if (/^\d{8}T\d{6}$/.test(vv)){
    const y = vv.slice(0,4), m = vv.slice(4,6), d = vv.slice(6,8);
    const hh = vv.slice(9,11), mm = vv.slice(11,13);
    return { date: `${y}-${m}-${d}`, time: `${hh}:${mm}`, allDay: false };
  }

  return null;
}

function safeText(s){
  return String(s || '')
    .replace(/\\n/g, '\n')
    .replace(/\\,/g, ',')
    .replace(/\\;/g, ';')
    .replace(/\\\\/g, '\\')
    .trim();
}

// Format tanggal untuk display
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('id-ID', {
        weekday: 'short',
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

// Hitung durasi dalam hari
function calculateDuration(startDate, endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    const diffTime = Math.abs(end - start);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
    return diffDays;
}

// Validasi input
function validateEvent(event) {
    if (!event.subject.trim()) {
        throw new Error('Judul acara harus diisi');
    }
    
    if (!event.startDate) {
        throw new Error('Tanggal mulai harus diisi');
    }
    
    if (!event.endDate) {
        throw new Error('Tanggal selesai harus diisi');
    }
    
    const start = new Date(event.startDate);
    const end = new Date(event.endDate);
    
    if (end < start) {
        throw new Error('Tanggal selesai tidak boleh sebelum tanggal mulai');
    }
    
    // Validasi waktu jika bukan all-day event
    if (!event.allDay) {
        if (event.startTime && event.endTime) {
            const startTime = new Date(`${event.startDate}T${event.startTime}`);
            const endTime = new Date(`${event.startDate}T${event.endTime}`);
            
            if (start.getDate() === end.getDate() && startTime >= endTime) {
                throw new Error('Waktu selesai harus setelah waktu mulai untuk acara 1 hari');
            }
        }
    }
    
    return true;
}

// Tambah / Update event manual
function addManualEvent() {
  try {
    const event = getFormEvent();
    validateEvent(event);

    if (editIndex >= 0) {
      // OVERWRITE data lama
      events[editIndex] = event;
      showNotification('Perubahan berhasil disimpan (overwrite data lama)!', 'success');
      editIndex = -1;
    } else {
      // TAMBAH baru
      events.push(event);
      showNotification('Acara berhasil ditambahkan!', 'success');
    }

    renderEvents();
    saveEventsLocal();
    resetFormToDefault();

  } catch (error) {
    showNotification(error.message, 'error');
  }
}

// Render tabel events
function renderEvents() {
    const tbody = document.getElementById('eventsBody');
    const totalEvents = document.getElementById('totalEvents');
    const multiDayCount = document.getElementById('multiDayCount');
    
    tbody.innerHTML = '';
    
    let multiDayEvents = 0;
    
    events.forEach((event, index) => {
        const duration = calculateDuration(event.startDate, event.endDate);
        const isMultiDay = duration > 1;
        
        if (isMultiDay) multiDayEvents++;
        
        const row = document.createElement('tr');
        
        // Format waktu untuk display
        let timeDisplay = event.allDay ? 'Seharian' : 
                         (event.startTime && event.endTime) ? 
                         `${event.startTime} - ${event.endTime}` : 'Waktu belum diatur';
        
        row.innerHTML = `
            <td>${index + 1}</td>
            <td>
                <strong>${event.subject}</strong>
                ${event.location ? `<br><small><i class="fas fa-map-marker-alt"></i> ${event.location}</small>` : ''}
            </td>
            <td>${formatDate(event.startDate)}</td>
            <td>${formatDate(event.endDate)}</td>
            <td>${timeDisplay}</td>
            <td>
                <span class="${isMultiDay ? 'multi-day' : 'duration'}">
                    ${duration} ${duration === 1 ? 'hari' : 'hari'}
                </span>
            </td>
            <td>
              <button onclick="editEvent(${index})" class="edit-btn">
                <i class="fas fa-pen"></i> Edit
              </button>
              <button onclick="deleteEvent(${index})" class="delete-btn">
                <i class="fas fa-trash"></i> Hapus
              </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
    
    totalEvents.textContent = events.length;
    multiDayCount.textContent = multiDayEvents;
    
    // Update judul section
    document.querySelector('.events-list h3').innerHTML = 
        `<i class="fas fa-list"></i> Daftar Acara (${events.length} acara)`;
}

// Hapus event
function deleteEvent(index) {
    if (confirm('Hapus acara ini?')) {
        events.splice(index, 1);
        renderEvents();
        saveEventsLocal();
        showNotification('Acara berhasil dihapus', 'success');
    }
}

// Edit event: load data ke form & aktifkan mode edit
function editEvent(index){
  const ev = events[index];
  if (!ev) return;

  editIndex = index;
  setFormEvent(ev);
  updateAddButtonUI();

  // scroll ke form agar langsung terlihat
  const formBox = document.querySelector('.manual-input');
  if (formBox) formBox.scrollIntoView({ behavior: 'smooth', block: 'start' });

  showNotification('Mode edit aktif. Ubah data lalu klik "Simpan Perubahan".', 'info');
}

// Generate CSV untuk diupload ke Google Calendar
function generateCSV() {
    if (events.length === 0) {
        showNotification('Tidak ada acara untuk diexport!', 'error');
        return;
    }
    
    try {
        const csvData = events.map(event => {
            // Format untuk Google Calendar
            const csvEvent = {
                'Subject': event.subject,
                'Start Date': formatDateForCSV(event.startDate),
                'Start Time': event.allDay ? '' : (event.startTime || '09:00'),
                'End Date': formatDateForCSV(event.endDate),
                'End Time': event.allDay ? '' : (event.endTime || '17:00'),
                'Description': event.description || '',
                'Location': event.location || ''
            };
            
            return csvEvent;
        });
        
        const csv = Papa.unparse(csvData);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `google_calendar_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('File CSV berhasil didownload!', 'success');
        
    } catch (error) {
        showNotification('Error saat generate CSV: ' + error.message, 'error');
    }
}

// Format tanggal untuk CSV (YYYY-MM-DD)
function formatDateForCSV(dateString) {
    const date = new Date(dateString);
    return date.toISOString().split('T')[0];
}

// Download template CSV
function downloadTemplate() {
    const template = `Subject,Start Date,Start Time,End Date,End Time,Description,Location
Meeting Internal,2024-01-15,14:00,2024-01-15,15:00,Rapat tim mingguan,Ruang Meeting 1
Training Karyawan,2024-01-22,09:00,2024-01-24,17:00,Training soft skills untuk karyawan baru,Room A
Libur Nasional,2024-01-01,,2024-01-01,,Hari Tahun Baru,
Konferensi Tech,2024-02-10,08:00,2024-02-12,18:00,Konferensi teknologi terbesar,Convention Center
Cuti Panjang,2024-12-20,,2024-12-31,,Cuti akhir tahun,`;

    const blob = new Blob([template], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', 'template_google_calendar.csv');
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('Template berhasil didownload!', 'success');
}

// Generate file ICS (alternatif)
function importICS() {
    if (events.length === 0) {
        showNotification('Tidak ada acara untuk diexport ke ICS!', 'error');
        return;
    }
    
    let icsContent = `BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//Google Calendar Bulk Upload//ID
METHOD:PUBLISH
X-WR-CALNAME:Generated Calendar
X-WR-TIMEZONE:Asia/Jakarta
X-WR-CALDESC:Calendar generated from bulk upload
`;
    
    events.forEach((event, index) => {
        const uid = `${Date.now() + index}@googlecalendarbulk`;
        const startDate = formatDateForICS(event.startDate, event.allDay ? null : event.startTime);
        const endDate = formatDateForICS(event.endDate, event.allDay ? null : event.endTime);
        
        icsContent += `BEGIN:VEVENT
UID:${uid}
DTSTAMP:${formatDateForICS(new Date().toISOString().split('T')[0])}T000000Z
${event.allDay ? 'DTSTART;VALUE=DATE:' + startDate.split('T')[0] : 'DTSTART:' + startDate}
${event.allDay ? 'DTEND;VALUE=DATE:' + endDate.split('T')[0] : 'DTEND:' + endDate}
SUMMARY:${event.subject}
${event.description ? 'DESCRIPTION:' + event.description.replace(/\n/g, '\\n') : ''}
${event.location ? 'LOCATION:' + event.location : ''}
STATUS:CONFIRMED
END:VEVENT
`;
    });
    
    icsContent += 'END:VCALENDAR';
    
    const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `calendar_${new Date().toISOString().split('T')[0]}.ics`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('File ICS berhasil didownload!', 'success');
}

// =====================
// IMPORT .ICS (iCalendar) -> events[]
// =====================
function pickICSFile(){
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.accept = '.ics,text/calendar';
  inp.onchange = async (e) => {
    const f = e.target.files && e.target.files[0];
    if (!f) return;

    try{
      const text = await f.text();
      const imported = importFromICSText(text);
      renderEvents();
      saveEventsLocal();
      showNotification(`Berhasil import ${imported} acara dari ICS`, 'success');
    }catch(err){
      showNotification('Gagal import ICS: ' + err.message, 'error');
    }
  };
  inp.click();
}

function importFromICSText(icsText){
  const text = String(icsText || '');

  // Unfolding lines (RFC): lines can be folded with CRLF + space/tab
  const unfolded = text.replace(/\r?\n[ \t]/g, '');

  // Split VEVENT blocks
  const blocks = unfolded.split('BEGIN:VEVENT').slice(1);
  let count = 0;

  for (const b0 of blocks){
    const b = b0.split('END:VEVENT')[0] || '';
    const lines = b.split(/\r?\n/).map(x => x.trim()).filter(Boolean);

    const raw = {};
    for (const ln of lines){
      const idx = ln.indexOf(':');
      if (idx < 0) continue;

      const left = ln.slice(0, idx);   // e.g. DTSTART;VALUE=DATE
      const val  = ln.slice(idx + 1);

      const key = left.split(';')[0].toUpperCase();
      raw[key] = val;
      // also store full key variant if needed
      raw[left.toUpperCase()] = val;
    }

    // DTSTART / DTEND can be with ;VALUE=DATE
    const dtStart = raw['DTSTART'] || raw['DTSTART;VALUE=DATE'] || raw['DTSTART;VALUE=DATE;TZID=ASIA/JAKARTA'];
    const dtEnd   = raw['DTEND']   || raw['DTEND;VALUE=DATE']   || raw['DTEND;VALUE=DATE;TZID=ASIA/JAKARTA'];

    const pStart = parseICalDate(dtStart);
    const pEnd   = parseICalDate(dtEnd);

    if (!pStart) continue;

    // iCal all-day DTEND is typically exclusive (end date not included).
    // Agar sesuai UI Anda (inklusif), kita adjust jika all-day dan DTEND ada:
    let endDate = pStart.date;
    if (pEnd && pEnd.date){
      endDate = pEnd.date;
      if (pStart.allDay && pEnd.allDay){
        // DTEND exclusive -> kurangi 1 hari
        const d = new Date(endDate + 'T00:00:00');
        d.setDate(d.getDate() - 1);
        endDate = d.toISOString().split('T')[0];
      }
    }

    const ev = {
      subject: safeText(raw['SUMMARY'] || ''),
      startDate: pStart.date,
      endDate: endDate,
      startTime: pStart.allDay ? '' : (pStart.time || ''),
      endTime: (pEnd && !pEnd.allDay) ? (pEnd.time || '') : '',
      location: safeText(raw['LOCATION'] || ''),
      description: safeText(raw['DESCRIPTION'] || ''),
      allDay: !!pStart.allDay
    };

    // minimal validation (judul & tanggal start)
    if (!ev.subject || !ev.startDate) continue;

    // optional: jika endDate kosong, samakan
    if (!ev.endDate) ev.endDate = ev.startDate;

    events.push(ev);
    count++;
  }

  return count;
}

// =====================
// EXPORT .XLSX (Excel)
// =====================
function generateXLSX(){
  if (events.length === 0) {
    showNotification('Tidak ada acara untuk diexport!', 'error');
    return;
  }

  if (typeof XLSX === 'undefined'){
    showNotification('Library XLSX tidak ditemukan. Pastikan file ./vendor/xlsx.full.min.js ada dan sudah dipanggil di index.html.', 'error');
    return;
  }

  try{
    const rows = events.map((event, i) => ({
      'No': i + 1,
      'Subject': event.subject,
      'Start Date': formatDateForCSV(event.startDate),
      'Start Time': event.allDay ? '' : (event.startTime || '09:00'),
      'End Date': formatDateForCSV(event.endDate),
      'End Time': event.allDay ? '' : (event.endTime || '17:00'),
      'All Day': event.allDay ? 'YES' : 'NO',
      'Location': event.location || '',
      'Description': event.description || ''
    }));

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(rows);

    ws['!cols'] = [
      { wch: 5 },  { wch: 30 }, { wch: 12 }, { wch: 10 },
      { wch: 12 }, { wch: 10 }, { wch: 8  }, { wch: 22 }, { wch: 45 }
    ];

    XLSX.utils.book_append_sheet(wb, ws, 'Events');
    const fname = `google_calendar_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, fname);

    showNotification('File XLSX berhasil didownload!', 'success');
  }catch(err){
    showNotification('Error saat generate XLSX: ' + err.message, 'error');
  }
}

// Format tanggal untuk ICS
function formatDateForICS(dateString, timeString = null) {
    const date = new Date(dateString);
    let formatted = date.toISOString().replace(/[-:]/g, '').split('.')[0];
    
    if (timeString) {
        const [hours, minutes] = timeString.split(':');
        formatted = formatted.split('T')[0] + 'T' + hours + minutes + '00';
    }
    
    return formatted;
}

// Hapus semua
function clearAll() {
  if (events.length === 0 && !localStorage.getItem(STORAGE_KEY_EVENTS)) {
    showNotification('Data sudah kosong.', 'info');
    return;
  }

  if (confirm(`Hapus semua ${events.length} acara? Ini juga akan menghapus data lokal aplikasi ini.`)) {
    events = [];
    editIndex = -1;
    clearEventsLocal();      // ✅ hapus storage aplikasi ini saja
    renderEvents();
    updateAddButtonUI();
    resetFormToDefault();
    showNotification('Semua acara & penyimpanan lokal berhasil dihapus', 'success');
  }
}

// Buka Google Calendar
function openGoogleCalendar() {
    window.open('https://calendar.google.com/calendar/u/0/r/settings/export', '_blank');
}

// Show notification
function showNotification(message, type = 'info') {
  ensureNotificationStyle();

  // Remove existing notification
  const existingNotification = document.querySelector('.notification');
  if (existingNotification) existingNotification.remove();

  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
    <span>${message}</span>
    <button onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
  `;

  document.body.appendChild(notification);

  setTimeout(() => {
    if (notification.parentElement) notification.remove();
  }, 5000);
}

// Initialize dengan contoh data
window.onload = function() {
    // Set default tanggal untuk form
    const today = new Date();
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    document.getElementById('startDate').value = today.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
    document.getElementById('startTime').value = '09:00';
    document.getElementById('endTime').value = '17:00';
    
    // Contoh data dummy untuk demo
    events = loadEventsLocal();
    
    renderEvents();
    updateAddButtonUI();
    
    // Handle file upload (CSV/XLSX/ICS)
    document.getElementById('fileInput').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const name = (file.name || '').toLowerCase();

    try{
        // 1) CSV
        if (name.endsWith('.csv')){
        const text = await file.text();

        Papa.parse(text, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
            let importedCount = 0;

            results.data.forEach(row => {
                if (row.Subject && row['Start Date']) {
                const isAllDay = !row['Start Time'] && !row['End Time'];

                events.push({
                    subject: row.Subject,
                    startDate: row['Start Date'],
                    endDate: row['End Date'] || row['Start Date'],
                    startTime: row['Start Time'] || '',
                    endTime: row['End Time'] || '',
                    location: row.Location || '',
                    description: row.Description || '',
                    allDay: isAllDay
                });
                importedCount++;
                }
            });

            renderEvents();
            saveEventsLocal();
            showNotification(`Berhasil mengimpor ${importedCount} acara dari CSV`, 'success');
            },
            error: function(error) {
            showNotification('Error membaca CSV: ' + error.message, 'error');
            }
        });

        return;
        }

        // 2) ICS
        if (name.endsWith('.ics')){
        const text = await file.text();
        const imported = importFromICSText(text);
        renderEvents();
        saveEventsLocal();
        showNotification(`Berhasil mengimpor ${imported} acara dari ICS`, 'success');
        return;
        }

        // 3) XLSX/XLS
        if (name.endsWith('.xlsx') || name.endsWith('.xls')){
        if (typeof XLSX === 'undefined'){
            showNotification('Library XLSX belum termuat. Pastikan sudah menambahkan script SheetJS.', 'error');
            return;
        }

        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, { type: 'array' });

        // Ambil sheet pertama
        const sheetName = wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });

        let importedCount = 0;

        rows.forEach(row => {
            // dukung header umum: Subject, Start Date, Start Time, End Date, End Time, Description, Location
            const subject = row['Subject'] || row['subject'] || row['Judul'] || row['Judul Acara'] || '';
            const startDate = row['Start Date'] || row['startDate'] || row['Tanggal Mulai'] || '';
            const endDate = row['End Date'] || row['endDate'] || row['Tanggal Selesai'] || startDate;

            if (!subject || !startDate) return;

            const startTime = row['Start Time'] || row['startTime'] || row['Waktu Mulai'] || '';
            const endTime = row['End Time'] || row['endTime'] || row['Waktu Selesai'] || '';
            const desc = row['Description'] || row['description'] || row['Deskripsi'] || '';
            const loc  = row['Location'] || row['location'] || row['Lokasi'] || '';

            const isAllDay = !startTime && !endTime;

            events.push({
            subject: String(subject),
            startDate: String(startDate),
            endDate: String(endDate || startDate),
            startTime: String(startTime || ''),
            endTime: String(endTime || ''),
            location: String(loc || ''),
            description: String(desc || ''),
            allDay: isAllDay
            });

            importedCount++;
        });

        renderEvents();
        saveEventsLocal();
        showNotification(`Berhasil mengimpor ${importedCount} acara dari Excel`, 'success');
        return;
        }

        showNotification('Format file tidak dikenali. Gunakan CSV/XLSX/ICS.', 'error');

    }catch(err){
        showNotification('Gagal membaca file: ' + err.message, 'error');
    }
    try { await loadXLSXLibOnce(); } catch(e) { /* abaikan, nanti dicoba lagi saat klik */ }
    });
};
    </script>
</body>
</html>